<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Assets — Clarity Labs</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #F0F4F8;
            --text: #0a1628;
            --text-secondary: #64748B;
            --accent: #61F393;
            --accent-muted: rgba(97, 243, 147, 0.1);
            --border: #E2E8F0;
            --danger: #EF4444;
            --card: #FFFFFF;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Manrope', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Nav */
        nav {
            position: fixed; top: 0; left: 0; right: 0; height: 56px;
            background: var(--text); display: flex; align-items: center;
            padding: 0 24px; z-index: 1000;
        }
        nav a { display: flex; align-items: center; text-decoration: none; }
        nav img { height: 28px; }

        /* Main */
        .container {
            max-width: 720px; margin: 0 auto; padding: 80px 24px 40px;
        }

        h1 { font-size: 2rem; margin-bottom: 8px; }
        .subtitle { color: var(--text-secondary); font-size: 1rem; margin-bottom: 32px; line-height: 1.6; }

        /* Auth */
        .auth-bar {
            background: var(--card); border: 1px solid var(--border); border-radius: 12px;
            padding: 20px 24px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;
        }
        .auth-bar input {
            flex: 1; border: 1px solid var(--border); border-radius: 8px;
            padding: 10px 14px; font-family: inherit; font-size: 0.85rem;
        }
        .auth-bar input:focus { outline: none; border-color: var(--accent); }
        .auth-status {
            font-size: 0.8rem; font-weight: 600; padding: 6px 12px;
            border-radius: 6px; white-space: nowrap;
        }
        .auth-status.connected { background: var(--accent-muted); color: #059669; }
        .auth-status.disconnected { background: #FEE2E2; color: var(--danger); }

        /* Upload Zone */
        .upload-zone {
            background: var(--card); border: 2px dashed var(--border); border-radius: 16px;
            padding: 60px 40px; text-align: center; cursor: pointer;
            transition: all 0.2s ease; margin-bottom: 24px;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--accent); background: var(--accent-muted);
        }
        .upload-zone h3 { font-size: 1.1rem; margin-bottom: 8px; }
        .upload-zone p { color: var(--text-secondary); font-size: 0.85rem; }
        .upload-zone input { display: none; }

        /* Form */
        .upload-form {
            background: var(--card); border: 1px solid var(--border); border-radius: 16px;
            padding: 28px; margin-bottom: 24px; display: none;
        }
        .upload-form.visible { display: block; }

        .preview-row {
            display: flex; align-items: center; gap: 16px; margin-bottom: 20px;
            padding-bottom: 20px; border-bottom: 1px solid var(--border);
        }
        .preview-img {
            width: 80px; height: 80px; border-radius: 10px; object-fit: cover;
            border: 1px solid var(--border);
        }
        .preview-info { flex: 1; }
        .preview-info .filename { font-weight: 700; font-size: 0.95rem; }
        .preview-info .filesize { color: var(--text-secondary); font-size: 0.8rem; }

        .field { margin-bottom: 16px; }
        .field label {
            display: block; font-size: 0.75rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px;
            color: var(--text-secondary); margin-bottom: 6px;
        }
        .field input, .field select {
            width: 100%; border: 1px solid var(--border); border-radius: 8px;
            padding: 10px 14px; font-family: inherit; font-size: 0.9rem;
        }
        .field input:focus, .field select:focus { outline: none; border-color: var(--accent); }

        .field-hint {
            font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;
        }

        .btn {
            display: inline-flex; align-items: center; gap: 8px;
            background: var(--accent); color: var(--text); border: none;
            padding: 14px 28px; border-radius: 10px; font-family: inherit;
            font-size: 0.95rem; font-weight: 700; cursor: pointer;
            transition: transform 0.15s ease, opacity 0.15s ease;
            width: 100%;  justify-content: center;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary {
            background: transparent; border: 1px solid var(--border);
            color: var(--text-secondary); font-weight: 600;
        }

        /* Path Output */
        .path-output {
            background: var(--text); color: var(--accent); border-radius: 12px;
            padding: 20px 24px; font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.85rem; margin-bottom: 12px; display: none;
            word-break: break-all;
        }
        .path-output.visible { display: block; }

        .copy-hint {
            font-size: 0.8rem; color: var(--text-secondary); text-align: center;
            display: none; margin-bottom: 24px;
        }
        .copy-hint.visible { display: block; }

        /* Recent Uploads */
        .recent { margin-top: 40px; }
        .recent h2 { font-size: 1.2rem; margin-bottom: 16px; }
        .recent-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }
        .recent-item {
            background: var(--card); border: 1px solid var(--border); border-radius: 10px;
            overflow: hidden; cursor: pointer; transition: box-shadow 0.2s;
        }
        .recent-item:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
        .recent-item img {
            width: 100%; height: 100px; object-fit: cover;
        }
        .recent-item .recent-name {
            padding: 8px 10px; font-size: 0.7rem; font-weight: 600;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .recent-item .recent-path {
            padding: 0 10px 8px; font-size: 0.6rem; color: var(--text-secondary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* Toast */
        .toast {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: var(--text); color: white; padding: 14px 24px; border-radius: 10px;
            font-size: 0.85rem; font-weight: 600; transition: transform 0.3s ease;
            z-index: 2000; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* Spinner */
        .spinner {
            width: 18px; height: 18px; border: 2px solid transparent;
            border-top-color: var(--text); border-radius: 50%;
            animation: spin 0.6s linear infinite; display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 600px) {
            .container { padding: 72px 16px 24px; }
            h1 { font-size: 1.5rem; }
            .upload-zone { padding: 40px 20px; }
            .preview-row { flex-direction: column; text-align: center; }
            .auth-bar { flex-direction: column; }
        }
    </style>
</head>
<body>
    <nav>
        <a href="index.html">
            <img src="shared/brand/clarity-logo-white.svg" alt="Clarity">
        </a>
    </nav>

    <div class="container">
        <h1>Upload Assets</h1>
        <p class="subtitle">Upload images for use in presentations. Files go directly into the shared asset library — Claude Code can use them immediately.</p>

        <!-- GitHub Auth -->
        <div class="auth-bar" id="authBar">
            <div style="flex: 1;">
                <input type="password" id="tokenInput" placeholder="Paste your GitHub personal access token">
                <div class="field-hint" style="margin-top: 4px;">Need a token? <a href="https://github.com/settings/tokens/new?scopes=repo&description=Clarity+Labs+Upload" target="_blank" style="color: var(--accent);">Create one here</a> (select "repo" scope)</div>
            </div>
            <button class="btn" onclick="saveToken()" style="width: auto; padding: 10px 20px; font-size: 0.85rem;" id="authBtn">Connect</button>
            <div class="auth-status disconnected" id="authStatus">Not connected</div>
        </div>

        <!-- Upload Zone -->
        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept="image/*,.svg">
            <h3>Drop an image here or click to browse</h3>
            <p>PNG, JPG, SVG, WebP — up to 10MB</p>
        </div>

        <!-- Upload Form -->
        <div class="upload-form" id="uploadForm">
            <div class="preview-row">
                <img class="preview-img" id="previewImg" src="" alt="Preview">
                <div class="preview-info">
                    <div class="filename" id="fileName">image.png</div>
                    <div class="filesize" id="fileSize">0 KB</div>
                </div>
                <button class="btn btn-secondary" onclick="resetForm()" style="width: auto; padding: 8px 16px; font-size: 0.8rem;">Change</button>
            </div>

            <div class="field">
                <label>Asset Name</label>
                <input type="text" id="assetName" placeholder="e.g. greenhouse-dashboard">
                <div class="field-hint">Lowercase, hyphens for spaces. This becomes the filename.</div>
            </div>

            <div class="field">
                <label>Category</label>
                <select id="assetCategory">
                    <option value="screenshots">Screenshots — Product UI, dashboards, app screens</option>
                    <option value="logos">Logos — Company or partner logos</option>
                    <option value="people">People — Headshots, team photos</option>
                    <option value="compliance">Compliance — Certification badges</option>
                    <option value="custom">Deck-Specific — For a specific presentation</option>
                </select>
            </div>

            <div class="field" id="deckField" style="display: none;">
                <label>Presentation Folder</label>
                <input type="text" id="deckFolder" placeholder="e.g. presentations/my-deck/assets">
                <div class="field-hint">Path relative to repo root where this image should go.</div>
            </div>

            <div class="field">
                <label>Description (optional)</label>
                <input type="text" id="assetDescription" placeholder="e.g. Greenhouse ATS integration dashboard view">
                <div class="field-hint">Helps Claude Code understand what this image shows.</div>
            </div>

            <button class="btn" id="uploadBtn" onclick="uploadAsset()">
                Upload to Clarity Labs
            </button>
        </div>

        <!-- Path Output -->
        <div class="path-output" id="pathOutput"></div>
        <div class="copy-hint" id="copyHint">Click the path to copy — then paste it into Claude Code</div>

        <!-- Recent Uploads -->
        <div class="recent" id="recentSection" style="display: none;">
            <h2>Recently Uploaded</h2>
            <div class="recent-grid" id="recentGrid"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const REPO = 'MichaelMatiasOrg/clarity-demo';
        const BRANCH = 'main';

        // Category → folder mapping
        const CATEGORY_PATHS = {
            screenshots: 'shared/screenshots',
            logos: 'shared/logos',
            people: 'shared/people',
            compliance: 'shared/compliance',
            custom: '' // user specifies
        };

        let selectedFile = null;
        let fileBase64 = null;

        // Token management
        function getToken() { return localStorage.getItem('gh_token_clarity') || ''; }
        function saveToken() {
            const token = document.getElementById('tokenInput').value.trim();
            if (!token) return;
            localStorage.setItem('gh_token_clarity', token);
            checkAuth();
        }

        async function checkAuth() {
            const token = getToken();
            const status = document.getElementById('authStatus');
            const input = document.getElementById('tokenInput');

            if (!token) {
                status.textContent = 'Not connected';
                status.className = 'auth-status disconnected';
                return false;
            }

            try {
                const res = await fetch('https://api.github.com/user', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const user = await res.json();
                    status.textContent = `Connected as ${user.login}`;
                    status.className = 'auth-status connected';
                    input.value = '';
                    input.placeholder = '••••••••••••••••';
                    return true;
                }
            } catch (e) {}

            status.textContent = 'Invalid token';
            status.className = 'auth-status disconnected';
            return false;
        }

        // File handling
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        ['dragenter', 'dragover'].forEach(e => {
            uploadZone.addEventListener(e, ev => { ev.preventDefault(); uploadZone.classList.add('dragover'); });
        });
        ['dragleave', 'drop'].forEach(e => {
            uploadZone.addEventListener(e, ev => { ev.preventDefault(); uploadZone.classList.remove('dragover'); });
        });
        uploadZone.addEventListener('drop', ev => { handleFile(ev.dataTransfer.files[0]); });
        fileInput.addEventListener('change', ev => { if (ev.target.files[0]) handleFile(ev.target.files[0]); });

        function handleFile(file) {
            if (!file || !file.type.match(/image|svg/)) {
                showToast('Please select an image file');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                showToast('File too large (max 10MB)');
                return;
            }

            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                fileBase64 = e.target.result.split(',')[1];
                document.getElementById('previewImg').src = e.target.result;
            };
            reader.readAsDataURL(file);

            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatSize(file.size);

            // Auto-suggest name from filename
            const name = file.name.replace(/\.[^.]+$/, '').replace(/[^a-zA-Z0-9-]/g, '-').toLowerCase();
            document.getElementById('assetName').value = name;

            // Auto-detect category from file type
            if (file.name.endsWith('.svg')) {
                document.getElementById('assetCategory').value = 'logos';
            }

            document.getElementById('uploadForm').classList.add('visible');
            document.getElementById('uploadZone').style.display = 'none';
        }

        // Category change handler
        document.getElementById('assetCategory').addEventListener('change', function() {
            document.getElementById('deckField').style.display = this.value === 'custom' ? 'block' : 'none';
        });

        // Upload
        async function uploadAsset() {
            const token = getToken();
            if (!token) { showToast('Connect your GitHub account first'); return; }
            if (!selectedFile || !fileBase64) { showToast('Select a file first'); return; }

            const name = document.getElementById('assetName').value.trim();
            if (!name) { showToast('Give the asset a name'); return; }

            const category = document.getElementById('assetCategory').value;
            const ext = selectedFile.name.split('.').pop().toLowerCase();
            const filename = `${name}.${ext}`;

            let folder;
            if (category === 'custom') {
                folder = document.getElementById('deckFolder').value.trim();
                if (!folder) { showToast('Specify the presentation folder'); return; }
            } else {
                folder = CATEGORY_PATHS[category];
            }

            const path = `${folder}/${filename}`;
            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Uploading...';

            try {
                // Check if file exists
                let sha;
                try {
                    const existing = await fetch(`https://api.github.com/repos/${REPO}/contents/${path}?ref=${BRANCH}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (existing.ok) {
                        const data = await existing.json();
                        sha = data.sha;
                    }
                } catch (e) {}

                // Get current user for commit message
                const userRes = await fetch('https://api.github.com/user', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = await userRes.json();
                const description = document.getElementById('assetDescription').value.trim();

                // Upload via GitHub Contents API
                const body = {
                    message: `Upload asset: ${filename}${description ? ' — ' + description : ''} (by ${user.login})`,
                    content: fileBase64,
                    branch: BRANCH
                };
                if (sha) body.sha = sha;

                const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.message || 'Upload failed');
                }

                // Success! Show the path
                const claudePath = category === 'custom' ? path : `../../${path}`;
                const pathOutput = document.getElementById('pathOutput');
                pathOutput.textContent = claudePath;
                pathOutput.classList.add('visible');
                pathOutput.onclick = () => {
                    navigator.clipboard.writeText(claudePath);
                    showToast('Path copied! Paste it into Claude Code');
                };
                pathOutput.style.cursor = 'pointer';
                document.getElementById('copyHint').classList.add('visible');

                // Save to recent uploads
                saveRecent({ name: filename, path: claudePath, category, preview: document.getElementById('previewImg').src, timestamp: Date.now() });
                renderRecent();

                showToast('Uploaded successfully!');
                btn.innerHTML = 'Uploaded!';

            } catch (e) {
                showToast('Error: ' + e.message);
                btn.disabled = false;
                btn.innerHTML = 'Upload to Clarity Labs';
            }
        }

        function resetForm() {
            selectedFile = null;
            fileBase64 = null;
            document.getElementById('uploadForm').classList.remove('visible');
            document.getElementById('uploadZone').style.display = 'block';
            document.getElementById('pathOutput').classList.remove('visible');
            document.getElementById('copyHint').classList.remove('visible');
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('uploadBtn').innerHTML = 'Upload to Clarity Labs';
            fileInput.value = '';
        }

        // Recent uploads (localStorage)
        function getRecent() {
            try { return JSON.parse(localStorage.getItem('clarity_recent_uploads') || '[]'); }
            catch { return []; }
        }
        function saveRecent(item) {
            const recent = getRecent();
            recent.unshift(item);
            localStorage.setItem('clarity_recent_uploads', JSON.stringify(recent.slice(0, 20)));
        }
        function renderRecent() {
            const recent = getRecent();
            const section = document.getElementById('recentSection');
            const grid = document.getElementById('recentGrid');
            if (recent.length === 0) { section.style.display = 'none'; return; }

            section.style.display = 'block';
            grid.innerHTML = recent.map(r => `
                <div class="recent-item" onclick="copyPath('${r.path}')">
                    <img src="${r.preview}" alt="${r.name}" onerror="this.style.background='var(--bg)';this.style.height='80px'">
                    <div class="recent-name">${r.name}</div>
                    <div class="recent-path">${r.path}</div>
                </div>
            `).join('');
        }
        function copyPath(path) {
            navigator.clipboard.writeText(path);
            showToast('Path copied! Paste it into Claude Code');
        }

        // Utils
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Init
        checkAuth();
        renderRecent();
    </script>
</body>
</html>
